# 高度なヒューリスティック戦略の統合

## 概要

参考コードで提供された高度なヒューリスティック戦略を現在のPIMC法ベースのAIに統合しました。
この統合により、既存の戦略に加えて、より洗練されたカード評価と戦略的パス判断が可能になります。

## 実装日

2026年1月20日

## 新機能

### 1. パラメータ駆動の評価システム

参考コードで使用されていた以下のパラメータを導入しました：

```python
ADVANCED_HEURISTIC_PARAMS = {
    'W_CIRCULAR_DIST': 22,    # 7からの距離（端に近いほど出しにくい）
    'W_MY_PATH': 112,         # 自分の次の手に繋がるボーナス
    'W_OTHERS_RISK': -127,    # 他人に塩を送るリスク（深度1あたりの減点）
    'W_SUIT_DOM': 84,         # スート支配力の重み
    'W_WIN_DASH': 41,         # 勝ち圏内の放出意欲
    'P_THRESHOLD_BASE': 118,  # 基本のパスしきい値
    'P_KILL_ZONE': 170,       # 相手をハメる時のパスしきい値
    'P_WIN_THRESHOLD': -31    # 勝ち圏内のパスしきい値
}
```

### 2. 円環距離評価 (Circular Distance)

7を中心とした円環上の距離を考慮し、端のカード（A/K）ほど保持価値が高いと評価します。

```python
# 1. 基本：円環距離 (端のカードほど保持価値が高い)
dist_from_7 = abs(n - 6)
circular_dist = min(dist_from_7, 13 - dist_from_7)
score += circular_dist * params['W_CIRCULAR_DIST']
```

**効果**: 端カードを温存することで、相手に道を開かずに戦略的優位を保つ。

### 3. 深度ベースの開放リスク評価 (Chain Risk)

カードを出すことで、どれだけ相手のために道を開いてしまうかを深度で評価します。

```python
def get_chain_risk(suit_idx, start_num, direction):
    """指定した方向に、自分が持っていないカードが何枚連続しているか(他人のための道)を計算"""
    risk_count = 0
    curr = (start_num + direction) % 13
    # トンネルがあるので最大6枚まで探索（7の反対側まで）
    for _ in range(6):
        if state.field_cards[suit_idx][curr] == 1:  # すでに出ている
            break
        if (suit_idx, curr) in my_hand_indices:  # 自分で止めている
            break
        # 誰かが持っているはずのカード
        risk_count += 1
        curr = (curr + direction) % 13
    return risk_count
```

**効果**: 相手に連続して出せる道を開いてしまうリスクを定量化し、より慎重な判断が可能に。

### 4. スート支配力の評価 (Suit Domination)

自分が多く持っているスートを優先的に進めることで、連鎖的に出せる確率を高めます。

```python
# 3. スート支配 (そのマークを多く持っているなら、そのマークを優先的に進める)
same_suit_count = suit_counts[s]
score += same_suit_count * params['W_SUIT_DOM']
```

**効果**: 自分が優位なスートを積極的に進め、手札を効率的に減らす。

### 5. 戦略的パス判断 (Strategic Pass)

ゲーム状況に応じて動的にパスしきい値を調整し、最適なタイミングでパスを選択します。

```python
# 戦略的パスの動的判断
pass_threshold = params['P_THRESHOLD_BASE']

# 相手のパスが尽きそうな時は、より「出さない」選択を強化
if opp_min_pass == 0:
    pass_threshold = params['P_KILL_ZONE']
elif opp_min_pass == 1:
    pass_threshold = params['P_KILL_ZONE'] * 0.7

# 自分のパス残弾が少ない時は、評価が低くても出す（自滅回避）
if (3 - my_pass_count) <= 1:
    pass_threshold = -9999

# 自分が勝てそうな時は、変に止めずに流す
if my_hands_count <= opp_min_hand and best_score > 0:
    pass_threshold = params['P_WIN_THRESHOLD']
```

**効果**: 
- 相手をバーストに追い込む（Kill Zone戦略）
- 自分のバーストを回避
- 勝ち圏内では積極的にカードを出す

### 6. トンネル端の特別処理強化

A/Kカードの扱いを精緻化し、トンネルを開ける際のリスクを評価します。

```python
# 特殊ルール補正: トンネルの端（1, 13）を出す際、逆側の状況を見る
if n == 0 or n == 12:
    opposite = 12 if n == 0 else 0
    if state.field_cards[i][opposite] == 0 and (i, opposite) not in my_hand_indices:
        # 逆側のカードを自分が持っていないのにトンネルを開けるのは非常に危険
        score -= 50
```

**効果**: トンネルルールを考慮し、不利な状況でのA/K出しを抑制。

## 統合方法

### メインAI (main.py)

1. **新しい評価メソッド**: `_evaluate_advanced_heuristic_strategy`を追加
2. **統合ポイント**: `_evaluate_strategic_actions`内で呼び出し
3. **重み付け**: `ADVANCED_HEURISTIC_WEIGHT = 0.8`で既存戦略とバランス
4. **戦略的パス**: `get_action`メソッド内で判断ロジックを追加

### 提出用AI (submission.py)

main.pyと同じ機能を実装し、大会提出用に最適化。

## 設定パラメータ

### 有効化フラグ

```python
ENABLE_ADVANCED_HEURISTIC = True  # 高度なヒューリスティックを有効化
```

### 重み調整

```python
ADVANCED_HEURISTIC_WEIGHT = 0.8   # 高度なヒューリスティックの重み
```

この重みにより、既存の戦略（トンネルロック、バースト誘導、通常のヒューリスティック等）との
バランスを調整します。

## 期待される効果

1. **端カード戦略の強化**: 円環距離評価により、A/Kの保持判断がより洗練される
2. **リスク管理の向上**: 深度ベースのリスク評価により、相手への道開きを最小化
3. **スート集中戦略**: 優位なスートを積極的に進め、手札削減効率が向上
4. **戦略的パス**: 相手の状況を見極めて最適なタイミングでパス
5. **トンネル戦略の精緻化**: A/K出しのタイミングがより戦略的に

## 既存戦略との統合

高度なヒューリスティック戦略は、以下の既存戦略と協調して動作します：

1. **PIMC法**: モンテカルロシミュレーションによる勝率評価
2. **トンネルロック戦略**: トンネルを利用した封鎖戦略
3. **バースト誘導戦略**: 相手をバーストに追い込む戦略
4. **カードカウンティング**: 場のカード追跡による推論
5. **適応的ゲーム状態評価**: 序盤/中盤/終盤の判定

これらの戦略スコアが統合され、最終的な行動選択に反映されます。

## チューニング推奨事項

### パラメータ調整

以下のパラメータは状況に応じて調整可能：

1. **W_CIRCULAR_DIST** (22): 端カードの保持価値
   - 増やす: より慎重に端カードを保持
   - 減らす: 積極的に端カードを出す

2. **W_MY_PATH** (112): 自分の道のボーナス
   - 増やす: 連鎖可能性を重視
   - 減らす: 他の要素を重視

3. **W_OTHERS_RISK** (-127): 相手への道開きペナルティ
   - 絶対値を増やす: より慎重にカードを出す
   - 絶対値を減らす: 積極的にカードを出す

4. **W_SUIT_DOM** (84): スート支配力の重み
   - 増やす: スート集中を強化
   - 減らす: バランス型の戦略

### 重み調整

```python
ADVANCED_HEURISTIC_WEIGHT = 0.8  # 0.0～1.5の範囲で調整可能
```

- **0.8**: バランス型（推奨）
- **1.0**: 高度なヒューリスティックを重視
- **0.5**: 既存戦略を重視

## 技術的詳細

### 計算量

- **円環距離**: O(1)
- **深度リスク**: O(6) = O(1)（最大6枚探索）
- **スート支配**: O(手札サイズ)
- **トンネル判定**: O(1)

全体として、各候補カードに対してO(手札サイズ)の計算量で効率的に評価可能。

### メモリ使用量

- 追加の永続的なメモリ使用は最小限
- 一時的な計算用変数のみ

## テスト方法

### 単体テスト

```bash
cd src
python3 -c "import main; ai = main.HybridStrongestAI(0, 100); print('OK')"
```

### ベンチマーク

```bash
cd src
python3 benchmark.py  # 100ゲームでの勝率測定
```

期待される勝率: 75-85% (vs ランダムAI × 2)

## まとめ

参考コードで提供された高度なヒューリスティック戦略を統合することで、
既存のPIMC法ベースのAIに以下の改善が追加されました：

1. ✅ 円環距離評価による端カード戦略
2. ✅ 深度ベースのリスク評価
3. ✅ スート支配力の活用
4. ✅ 戦略的パス判断
5. ✅ トンネル端の精緻な処理

これらの改善により、より洗練された戦略的判断が可能となり、
勝率のさらなる向上が期待されます。

---

**作成日**: 2026年1月20日  
**バージョン**: v1.0  
**対象ファイル**: `src/main.py`, `src/submission.py`
